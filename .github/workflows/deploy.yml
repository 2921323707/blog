name: Deploy to Windows Server

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (PowerShell)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          # 部署过程中会执行 npm/pip 安装与向量库重建，默认超时偏短，拉长避免误杀
          command_timeout: 60m
          script_stop: true
          script: |
            powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command "$ErrorActionPreference='Stop'; $BLOG_DIR='${{ secrets.BLOG_DIR }}'; if ([string]::IsNullOrWhiteSpace($BLOG_DIR)) { $BLOG_DIR='C:\\Users\\Administrator\\src\\blog' }; if (-not (Test-Path $BLOG_DIR)) { throw ('BLOG_DIR 不存在: ' + $BLOG_DIR) }; Set-Location $BLOG_DIR; if (Test-Path 'C:\\Tools\\Git\\cmd\\git.exe') { $env:Path = 'C:\\Tools\\Git\\cmd;C:\\Tools\\Git\\bin;' + $env:Path }; git --version; $srcDir = Join-Path $BLOG_DIR 'source'; $postsDir = Join-Path $srcDir '_posts'; $persistRoot = Join-Path $BLOG_DIR '.server_data'; $persistPosts = Join-Path $persistRoot 'posts'; if (Test-Path $postsDir) { New-Item -ItemType Directory -Force -Path $persistRoot | Out-Null; New-Item -ItemType Directory -Force -Path $persistPosts | Out-Null; & robocopy $postsDir $persistPosts /MIR /R:1 /W:1 /NFL /NDL /NJH /NJS /NP | Out-Null; $rc=$LASTEXITCODE; if ($rc -ge 8) { throw ('备份 _posts 失败: robocopy exit=' + $rc) } }; git fetch origin; git reset --hard origin/main; if (Test-Path $persistPosts) { New-Item -ItemType Directory -Force -Path $srcDir | Out-Null; New-Item -ItemType Directory -Force -Path $postsDir | Out-Null; & robocopy $persistPosts $postsDir /MIR /R:1 /W:1 /NFL /NDL /NJH /NJS /NP | Out-Null; $rc=$LASTEXITCODE; if ($rc -ge 8) { throw ('恢复 _posts 失败: robocopy exit=' + $rc) } }; $env:BLOG_DIR=$BLOG_DIR; $env:NODE_EXE='${{ secrets.NODE_EXE }}'; $env:PYTHON_EXE='${{ secrets.PYTHON_EXE }}'; $env:NGINX_EXE='${{ secrets.NGINX_EXE }}'; $env:NGINX_PATH='${{ secrets.NGINX_PATH }}'; $env:NGINX_CONF='${{ secrets.NGINX_CONF }}'; $env:START_HEXO_SERVER='${{ secrets.START_HEXO_SERVER }}'; powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -File \"$BLOG_DIR\\deploy.ps1\""
