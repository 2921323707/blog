name: Deploy to Windows Server

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (PowerShell)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script_stop: true
          script: |
            powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command "$ErrorActionPreference='Stop'; $BLOG_DIR='${{ secrets.BLOG_DIR }}'; if ([string]::IsNullOrWhiteSpace($BLOG_DIR)) { $BLOG_DIR='C:\\Users\\29213\\Desktop\\blog' }; if (-not (Test-Path $BLOG_DIR)) { throw ('BLOG_DIR 不存在: ' + $BLOG_DIR) }; Set-Location $BLOG_DIR; git fetch origin; git reset --hard origin/main; $env:BLOG_DIR=$BLOG_DIR; $env:NODE_EXE='${{ secrets.NODE_EXE }}'; $env:PYTHON_EXE='${{ secrets.PYTHON_EXE }}'; $env:NGINX_EXE='${{ secrets.NGINX_EXE }}'; $env:NGINX_PATH='${{ secrets.NGINX_PATH }}'; $env:NGINX_CONF='${{ secrets.NGINX_CONF }}'; $env:START_HEXO_SERVER='${{ secrets.START_HEXO_SERVER }}'; powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -File \"$BLOG_DIR\\deploy.ps1\""