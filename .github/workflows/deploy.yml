name: Auto Deploy to Server

on:
  push:
    branches:
      - main  # 当代码推送到 main 分支时触发
    # 可选：只监听特定目录的变化
    # paths:
    # - 'source/_posts/**'
    #   - '_config.yml'
    #   - 'themes/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Windows server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}          # 服务器地址
        username: ${{ secrets.SERVER_USER }}      # SSH 用户名
        key: ${{ secrets.SSH_PRIVATE_KEY }}       # SSH 私钥
        port: ${{ secrets.SERVER_PORT || '22' }}    # SSH 端口（默认22）
        script_stop: true  # 遇到错误时停止执行
        # Windows 服务器使用 PowerShell 执行命令
        script: |
          powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command "$ErrorActionPreference = 'Stop'; $BLOG_DIR = '${{ secrets.BLOG_DIR }}'; if ([string]::IsNullOrEmpty($BLOG_DIR)) { $BLOG_DIR = 'C:\\Users\\Administrator\\Desktop\\blog' }; $NODE_EXE = '${{ secrets.NODE_EXE }}'; if ([string]::IsNullOrEmpty($NODE_EXE)) { $NODE_EXE = 'C:\\Users\\Administrator\\depend\\node-v24.13.0-win-x64\\node.exe' }; if (-not (Test-Path $NODE_EXE)) { Write-Host \"错误: node.exe 未找到: $NODE_EXE\" -ForegroundColor Red; exit 1 }; $nodeDir = Split-Path -Parent $NODE_EXE; $env:Path = \"$nodeDir;$env:Path\"; Write-Host \"Node: $(& $NODE_EXE -v)  (from $NODE_EXE)\" -ForegroundColor Cyan; Write-Host \"========== 开始部署 ==========\" -ForegroundColor Green; Write-Host \"时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\" -ForegroundColor Cyan; if (-not (Test-Path $BLOG_DIR)) { Write-Host \"错误: 博客目录不存在: $BLOG_DIR\" -ForegroundColor Red; exit 1 }; Set-Location $BLOG_DIR; Write-Host \"当前目录: $(Get-Location)\" -ForegroundColor Cyan; Write-Host '-------- 处理本地更改 --------' -ForegroundColor Yellow; git fetch origin; git diff --quiet HEAD; if ($LASTEXITCODE -ne 0) { Write-Host '检测到本地更改，正在保存...' -ForegroundColor Yellow; $stashMsg = \"Auto stash before deployment - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\"; git stash save $stashMsg }; Write-Host '-------- 拉取最新代码 --------' -ForegroundColor Yellow; git reset --hard origin/main; if ($LASTEXITCODE -ne 0) { Write-Host '错误: 拉取代码失败' -ForegroundColor Red; exit 1 }; if (Test-Path 'package.json') { Write-Host '-------- 安装 npm 依赖 --------' -ForegroundColor Yellow; npm install }; Write-Host '-------- 生成静态文件 --------' -ForegroundColor Yellow; npx hexo clean; npx hexo generate; if ($LASTEXITCODE -ne 0) { Write-Host '错误: hexo generate 失败' -ForegroundColor Red; exit 1 }; $NGINX_PATH = '${{ secrets.NGINX_PATH }}'; if ([string]::IsNullOrEmpty($NGINX_PATH)) { $NGINX_PATH = 'C:\\Users\\Administrator\\Downloads\\nginx-1.28.1\\nginx.exe' }; $NGINX_CONF = (Join-Path $BLOG_DIR 'nginx.conf').Replace('\', '/'); if (Test-Path $NGINX_PATH) { Write-Host '-------- 重新加载 Nginx --------' -ForegroundColor Yellow; if (Test-Path $NGINX_CONF) { $nginxProcess = Get-Process -Name nginx -ErrorAction SilentlyContinue; if ($nginxProcess) { Write-Host 'Nginx 正在运行，发送重载信号...' -ForegroundColor Cyan; & $NGINX_PATH -s reload -c $NGINX_CONF } else { Write-Host 'Nginx 未运行，使用指定配置文件启动...' -ForegroundColor Cyan; $nginxDir = Split-Path -Parent $NGINX_PATH; Set-Location $nginxDir; & $NGINX_PATH -c $NGINX_CONF } } else { Write-Host \"警告: Nginx 配置文件未找到 ($NGINX_CONF)，使用默认配置\" -ForegroundColor Yellow; $nginxProcess = Get-Process -Name nginx -ErrorAction SilentlyContinue; if ($nginxProcess) { & $NGINX_PATH -s reload } else { $nginxDir = Split-Path -Parent $NGINX_PATH; Set-Location $nginxDir; & $NGINX_PATH } } } else { Write-Host \"提示: Nginx 路径未找到 ($NGINX_PATH)，跳过重载\" -ForegroundColor Yellow }; Write-Host '========== 部署完成！==========' -ForegroundColor Green; Write-Host \"完成时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\" -ForegroundColor Cyan"