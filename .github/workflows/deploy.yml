name: Auto Deploy to Server

on:
  push:
    branches:
      - main  # 当代码推送到 main 分支时触发
    # 可选：只监听特定目录的变化
    # paths:
    #   - 'source/_posts/**'
    #   - '_config.yml'
    #   - 'themes/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Windows server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}          # 服务器地址
        username: ${{ secrets.SERVER_USER }}      # SSH 用户名
        key: ${{ secrets.SSH_PRIVATE_KEY }}       # SSH 私钥
        port: ${{ secrets.SERVER_PORT || 22 }}    # SSH 端口（默认22）
        script_stop: true  # 遇到错误时停止执行
        # Windows 服务器使用 PowerShell 执行命令
        script: |
          powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command "$ErrorActionPreference = 'Stop'; Write-Host '========== 开始部署 ==========' -ForegroundColor Green; Write-Host \"时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\" -ForegroundColor Cyan; $BLOG_DIR = '${{ secrets.BLOG_DIR || 'C:\\Users\\Administrator\\Desktop\\blog' }}'; if (-not (Test-Path $BLOG_DIR)) { Write-Host \"错误: 博客目录不存在: $BLOG_DIR\" -ForegroundColor Red; exit 1 }; Set-Location $BLOG_DIR; Write-Host \"当前目录: $(Get-Location)\" -ForegroundColor Cyan; Write-Host '-------- 拉取最新代码 --------' -ForegroundColor Yellow; git pull origin main; if (Test-Path 'package.json') { Write-Host '-------- 安装 npm 依赖 --------' -ForegroundColor Yellow; npm install }; Write-Host '-------- 生成静态文件 --------' -ForegroundColor Yellow; npx hexo clean; npx hexo generate; $NGINX_PATH = '${{ secrets.NGINX_PATH || 'C:\\Users\\Administrator\\Downloads\\nginx-1.28.1\\nginx.exe' }}'; if (Test-Path $NGINX_PATH) { Write-Host '-------- 重新加载 Nginx --------' -ForegroundColor Yellow; & $NGINX_PATH -s reload } else { Write-Host \"提示: Nginx 路径未找到 ($NGINX_PATH)，跳过重载\" -ForegroundColor Yellow }; Write-Host '========== 部署完成！==========' -ForegroundColor Green; Write-Host \"完成时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\" -ForegroundColor Cyan"