# Nginx 反向代理配置 - Windows 1.28.1
# Hexo 博客 + Flask 后端评论系统

events {
    worker_connections 1024;
}

http {
    # 由于我们用 nginx.exe -p <BLOG_DIR> 方式启动，不能依赖 nginx 安装目录里的 conf/mime.types
    # 否则会出现 css/js 被当成 text/plain，浏览器会拒绝加载样式/脚本（看起来像"只有 HTML 没样式"）
    types {
        text/html                             html htm shtml;
        text/css                              css;
        image/gif                             gif;
        image/jpeg                            jpeg jpg;
        image/png                             png;
        image/svg+xml                         svg svgz;
        application/javascript                js;
        application/json                      json;
        application/xml                       xml;
        font/woff                             woff;
        font/woff2                            woff2;
        application/vnd.ms-fontobject         eot;
        application/x-font-ttf                ttf;
        application/x-font-opentype           otf;
    }
    default_type application/octet-stream;

    upstream flask_backend {
        server 127.0.0.1:5000;
        keepalive 32;
    }

    # HTTP 重定向到 HTTPS
    server {
        listen 80;
        server_name dodokolu.online www.dodokolu.online;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS 服务器
    server {
        listen 443 ssl;
        http2 on;
        server_name dodokolu.online www.dodokolu.online;

        # SSL 证书
        # 使用相对路径：通过 nginx.exe -p <BLOG_DIR> 指定前缀目录
        ssl_certificate ssl/dodoko.pem;
        ssl_certificate_key ssl/dodoko.key;

        # SSL 配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # 日志
        access_log logs/access.log;
        error_log logs/error.log;

        # Flask 后端 API
        location /api/ {
            # 设置请求体大小限制为 50MB（与 Flask 后端 MAX_CONTENT_LENGTH 保持一致）
            client_max_body_size 50m;
            proxy_pass http://flask_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            if ($request_method = 'OPTIONS') {
                return 204;
            }
        }

        # 管理后台（不暴露 5000：由 Nginx 统一对外提供）
        # 说明：后端 Flask 提供 /admin.html 及所有 /static/css/*、/static/js/*
        # 这里用"前缀匹配"反代，管理后台的所有静态资源都从后端获取
        location = /admin.html {
            proxy_pass http://flask_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /static/css/ {
            proxy_pass http://flask_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /static/js/ {
            proxy_pass http://flask_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 图片：优先从 public/ 提供；若刚上传尚未生成到 public/，则回源后端（source/img）
        location ^~ /img/ {
            try_files $uri @img_backend;
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        location @img_backend {
            proxy_pass http://flask_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # 静态文件根目录（Hexo 生成的 public 目录）
        root public;
        index index.html index.htm;

        # 前端静态文件（生产模式：直接提供静态文件）
        location / {
            # Hexo 是纯静态站点：不要回退到 /index.html（否则缺失的 css/js 会返回一份 HTML，页面就"只有字没样式"）
            try_files $uri $uri/ =404;
        }

        # HTML 不要强缓存（避免更新后浏览器仍旧看到旧页面/旧资源引用）
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache";
        }

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # 禁止访问隐藏文件
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Gzip 压缩
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    }
}
