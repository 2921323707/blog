- const { envId, region, option } = theme.twikoo
- const { use, lazyload, count } = theme.comments

// 引入评论系统CSS（使用BootCDN）
- const commentsCss = theme.CDN && theme.CDN.option && theme.CDN.option.comments_css || '/css/comments.css'
link(rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.min.css" crossorigin="anonymous")
link(rel="stylesheet" href=commentsCss)

script.
  (() => {
    const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
    const option = !{JSON.stringify(option)}

    const getCount = () => {
      const countELement = document.getElementById('twikoo-count')
      if(!countELement) return
      twikoo.getCommentsCount({
        urls: [window.location.pathname],
        includeReply: false
      }).then(res => {
        countELement.textContent = res[0].count
      }).catch(err => {
        console.error(err)
      })
    }

    const init = (el = document, path = location.pathname) => {
      twikoo.init({
        el: el.querySelector('#twikoo-wrap'),
        onCommentLoaded: () => {
          btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
        },
        ...option,
        path: isShuoshuo ? path : (option && option.path) || path
      })

      !{count ? `GLOBAL_CONFIG_SITE.pageType === 'post' && getCount()` : ''}

      isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      })
    }

    const loadTwikoo = (el = document, path = location.pathname) => {
      if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
      else {
        // 使用本地评论系统替代Twikoo
        // 从配置中获取API地址（已配置为 /api）
        let commentsApi = !{JSON.stringify(theme.twikoo.api_url || '')} || ''
        // 如果是相对路径，根据当前环境决定使用绝对路径还是相对路径
        if (commentsApi && commentsApi.startsWith('/')) {
          // 开发环境（4000端口或localhost）使用绝对路径指向5000端口
          if (window.location.port === '4000' || window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
            commentsApi = window.location.protocol + '//' + window.location.hostname + ':5000/api'
          }
          // 生产环境保持相对路径（通过nginx代理）
        } else if (!commentsApi) {
          // 如果未配置，根据环境使用智能默认值
          if (window.location.port === '4000' || window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
            commentsApi = window.location.protocol + '//' + window.location.hostname + ':5000/api'
          } else {
            commentsApi = '/api'
          }
        }
        window.COMMENTS_CDN_API = commentsApi
        window.COMMENTS_API = commentsApi
        btf.getScript('/js/comments.js').then(() => init(el, path)).catch(err => {
          console.error('Failed to load comments script:', err)
        })
      }
    }

    if (isShuoshuo) {
      '!{use[0]}' === 'Twikoo'
        ? window.shuoshuoComment = { loadComment: loadTwikoo }
        : window.loadOtherComment = loadTwikoo
      return
    }

    if ('!{use[0]}' === 'Twikoo' || !!{lazyload}) {
      if (!{lazyload}) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
      else setTimeout(() => loadTwikoo(), 0)
    } else {
      window.loadOtherComment = loadTwikoo
    }
  })()