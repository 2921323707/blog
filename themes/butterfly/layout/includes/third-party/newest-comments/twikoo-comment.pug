!= partial("includes/third-party/newest-comments/common.pug", {}, { cache: true })

script.
  window.addEventListener('load', () => {
    const keyName = 'twikoo-newest-comments'
    const { changeContent, generateHtml, run } = window.newestComments

    const getComment = ele => {
      const runTwikoo = () => {
        twikoo.getRecentComments({
          pageSize: !{newestCommentsLimit},
          includeReply: true
        }).then(res => {
          const twikooArray = res.map(e => {
            return {
              'content': changeContent(e.comment),
              'avatar': e.avatar,
              'nick': e.nick,
              'url': e.url + '#' + e.id,
              'date': new Date(e.created).toISOString()
            }
          })

          btf.saveToLocal.set(keyName, JSON.stringify(twikooArray), !{theme.aside.card_newest_comments.storage}/(60*24))
          generateHtml(twikooArray, ele)
        }).catch(err => {
          console.error(err)
          ele.textContent= "!{_p('aside.card_newest_comments.error')}"
        })
      }

      if (typeof twikoo === 'object') {
        runTwikoo()
      } else {
        let commentsApi = !{JSON.stringify(theme.twikoo.api_url || '')} || ''
        // 如果是相对路径，根据当前环境决定使用绝对路径还是相对路径
        if (commentsApi && commentsApi.startsWith('/')) {
          // 开发环境（4000端口或localhost）使用绝对路径指向5000端口
          if (window.location.port === '4000' || window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
            commentsApi = window.location.protocol + '//' + window.location.hostname + ':5000/api'
          }
          // 生产环境保持相对路径（通过nginx代理）
        } else if (!commentsApi) {
          // 如果未配置，根据环境使用智能默认值
          if (window.location.port === '4000' || window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
            commentsApi = window.location.protocol + '//' + window.location.hostname + ':5000/api'
          } else {
            commentsApi = '/api'
          }
        }
        window.COMMENTS_API = commentsApi
        btf.getScript('/js/comments.js').then(runTwikoo).catch(err => {
          console.error('Failed to load comments script:', err)
          ele.textContent= "!{_p('aside.card_newest_comments.error')}"
        })
      }
    }

    run(keyName, getComment)
  })



