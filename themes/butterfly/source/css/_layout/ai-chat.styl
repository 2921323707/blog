// AI Chat modal (MVP)

#ai-chat-dialog
  position: fixed
  right: 20px
  bottom: 90px
  z-index: 1001
  display: none
  flex-direction: column
  padding: 0
  box-sizing: border-box
  width: 420px
  max-width: calc(100vw - 40px)
  // 固定高度（桌面端），避免被消息撑大
  height: 617px
  max-height: calc(100vh - 120px)
  // glassmorphism (可爱/半透明/有质感)
  --ai-chat-glass-bg: rgba(255, 255, 255, .78)
  --ai-chat-glass-border: rgba(255, 255, 255, .55)
  --ai-chat-glass-shadow: 0 20px 65px rgba(0, 0, 0, .18)
  --ai-chat-soft-pink: rgba(255, 164, 206, .20)
  --ai-chat-soft-blue: rgba(73, 177, 245, .14)
  background: linear-gradient(135deg, var(--ai-chat-soft-pink), var(--ai-chat-soft-blue)), var(--ai-chat-glass-bg)
  color: var(--font-color)
  addBorderRadius(12, true)
  border: 1px solid var(--ai-chat-glass-border)
  box-shadow: var(--ai-chat-glass-shadow)
  overflow: hidden
  transition: box-shadow .3s, transform .3s, opacity .3s
  transform: translateZ(0)
  -webkit-font-smoothing: antialiased
  backdrop-filter: blur(18px) saturate(140%)
  -webkit-backdrop-filter: blur(18px) saturate(140%)
  isolation: isolate

  // 可爱高光 + 轻微纹理（不抢内容）
  &::before
    content: ''
    position: absolute
    inset: 0
    z-index: 0
    pointer-events: none
    background: radial-gradient(circle at 18% 8%, rgba(255, 255, 255, .55) 0%, rgba(255, 255, 255, 0) 45%),
      radial-gradient(circle at 92% 0%, rgba(73, 177, 245, .22) 0%, rgba(73, 177, 245, 0) 52%),
      linear-gradient(135deg, rgba(255, 164, 206, .10) 0%, rgba(255, 255, 255, 0) 38%, rgba(73, 177, 245, .08) 100%)
    opacity: .85

  > *
    position: relative
    z-index: 1

  [data-theme='dark'] &
    --ai-chat-glass-bg: rgba(20, 22, 26, .76)
    --ai-chat-glass-border: rgba(255, 255, 255, .12)
    --ai-chat-glass-shadow: 0 22px 70px rgba(0, 0, 0, .35)
    --ai-chat-soft-pink: rgba(255, 118, 179, .12)
    --ai-chat-soft-blue: rgba(73, 177, 245, .12)

  &:hover
    box-shadow: 0 22px 70px rgba(0, 0, 0, .22)

  +maxWidth768()
    // mobile: 底部玻璃拟态弹层（键盘弹起会自动上移）
    top: auto
    left: 12px
    right: 12px
    bottom: calc(12px + var(--ai-chat-bottom, 0px) + env(safe-area-inset-bottom))
    width: auto
    height: clamp(220px, calc(var(--ai-chat-height, 100dvh) - 140px), calc(var(--ai-chat-height, 100dvh) - 24px))
    max-width: none
    max-height: calc(var(--ai-chat-height, 100dvh) - 24px)
    addBorderRadius(18, true)
    // iOS 键盘 + fixed + transform 组合容易出现“局部放大/抖动”
    transform: none

  .ai-chat-nav
    display: flex
    justify-content: space-between
    align-items: center
    padding: 14px 16px
    background: rgba(255, 255, 255, .18)
    color: var(--font-color)
    font-size: 1.15em
    line-height: 1
    border-bottom: 1px solid rgba(255, 255, 255, .28)
    backdrop-filter: blur(14px) saturate(135%)
    -webkit-backdrop-filter: blur(14px) saturate(135%)

    [data-theme='dark'] &
      background: rgba(20, 22, 26, .35)
      border-bottom-color: rgba(255, 255, 255, .10)

    +maxWidth768()
      padding: calc(12px + env(safe-area-inset-top)) 12px 12px

    .ai-chat-title
      font-weight: 600
      letter-spacing: .2px
      &::after
        content: '  (ฅ´ω`ฅ)'
        font-weight: 400
        opacity: .75
        font-size: .92em

    .ai-chat-close-button
      display: inline-flex
      justify-content: center
      align-items: center
      width: 30px
      height: 30px
      border: none
      background: rgba(255, 255, 255, .22)
      color: var(--btn-color)
      addBorderRadius(6)
      @extend .btn-effects
      backdrop-filter: blur(12px) saturate(135%)
      -webkit-backdrop-filter: blur(12px) saturate(135%)

      [data-theme='dark'] &
        background: rgba(255, 255, 255, .10)

      &:hover
        background: rgba(255, 255, 255, .30)

      +maxWidth768()
        width: 34px
        height: 34px

  .ai-chat-body
    display: flex
    flex-direction: column
    gap: 12px
    padding: 12px 16px 16px
    // 让内容区在弹窗里自适应剩余高度（移动端键盘弹起时也能跟随）
    flex: 1
    min-height: 0

    +maxWidth768()
      padding: 12px
      padding-bottom: calc(12px + env(safe-area-inset-bottom))

  .ai-chat-messages
    flex: 1
    min-height: 0
    // 确保在 flex 容器里能正确收缩，从而出现滚动条
    height: 0
    padding: 10px 12px
    background: rgba(255, 255, 255, .30)
    border: 1px solid rgba(255, 255, 255, .32)
    border-radius: 10px
    overflow-x: hidden
    overflow-y: auto
    overscroll-behavior: contain
    -webkit-overflow-scrolling: touch
    backdrop-filter: blur(14px) saturate(135%)
    -webkit-backdrop-filter: blur(14px) saturate(135%)

    [data-theme='dark'] &
      background: rgba(20, 22, 26, .35)
      border-color: rgba(255, 255, 255, .12)

  .ai-chat-form
    display: flex
    gap: 10px
    align-items: center
    margin: 0
    padding: 8px
    background: rgba(255, 255, 255, .26)
    border: 1px solid rgba(255, 255, 255, .30)
    addBorderRadius(10, true)
    transition: border-color .2s ease, box-shadow .2s ease
    backdrop-filter: blur(14px) saturate(135%)
    -webkit-backdrop-filter: blur(14px) saturate(135%)

    [data-theme='dark'] &
      background: rgba(20, 22, 26, .32)
      border-color: rgba(255, 255, 255, .12)

    &:focus-within
      border-color: rgba($theme-color, .45)
      box-shadow: 0 0 0 3px rgba($theme-color, .16)

  .ai-chat-input
    flex: 1
    height: 38px
    padding: 0 10px
    border: none
    background: transparent
    color: var(--font-color)
    outline: none
    -webkit-appearance: none
    +maxWidth768()
      // iOS: input 字号 < 16px 会自动放大页面
      font-size: 16px

    &::placeholder
      color: var(--dark-grey)

  .ai-chat-send
    width: 42px
    height: 38px
    display: inline-flex
    justify-content: center
    align-items: center
    background: var(--btn-bg)
    color: var(--btn-color)
    addBorderRadius(10)
    @extend .btn-effects

    &:hover
      background: var(--btn-hover-color)

    &:focus-visible
      outline: 2px solid rgba($theme-color, .45)
      outline-offset: 2px

    +maxWidth768()
      width: 44px
      height: 40px

// message bubbles
.ai-chat-msg
  display: flex
  flex-direction: column
  align-items: flex-start
  margin: 8px 0

  .ai-chat-bubble
    max-width: 85%
    padding: 9px 12px
    line-height: 1.6
    white-space: pre-wrap
    word-break: break-word
    border: 1px solid var(--light-grey)
    background: var(--card-bg)
    color: var(--font-color)
    addBorderRadius(12, true)
    box-shadow: 0 2px 8px rgba(7, 17, 27, .06)

.ai-chat-msg--user
  align-items: flex-end

  .ai-chat-bubble
    border-color: rgba($theme-color, .22)
    background: linear-gradient(135deg, rgba($theme-color, .16), rgba(255, 164, 206, .12))

.ai-chat-msg--bot
  align-items: flex-start

  .ai-chat-bubble
    background: rgba(255, 255, 255, .28)
    border-color: rgba(255, 255, 255, .30)
    color: var(--font-color)

    [data-theme='dark'] &
      background: rgba(20, 22, 26, .32)
      border-color: rgba(255, 255, 255, .12)

// citations (sources)
.ai-chat-citations
  margin-top: 10px
  padding: 8px 10px
  border: 1px dashed var(--light-grey)
  background: var(--card-bg)
  addBorderRadius(10, true)

  &__summary
    cursor: pointer
    font-weight: 600
    font-size: .95em
    color: var(--font-color)
    user-select: none

  &[open]
    .ai-chat-citations__summary
      margin-bottom: 8px

  &__list
    margin: 0
    padding-left: 18px

  &__item
    margin: 6px 0

  &__row
    display: flex
    align-items: center
    justify-content: space-between
    gap: 10px

  &__link
    display: inline-block
    color: var(--theme-color)
    text-decoration: none
    word-break: break-word
    flex: 1
    min-width: 0

    &:hover
      text-decoration: underline

#ai-chat-mask
  position: fixed
  top: 0
  right: 0
  bottom: 0
  left: 0
  z-index: 1000
  display: none
  background: linear-gradient(135deg, rgba(0, 0, 0, .22), rgba(0, 0, 0, .35))
  backdrop-filter: blur(6px) saturate(115%)
  -webkit-backdrop-filter: blur(6px) saturate(115%)

  [data-theme='dark'] &
    background: linear-gradient(135deg, rgba(0, 0, 0, .38), rgba(0, 0, 0, .58))

@media (prefers-reduced-motion: reduce)
  #ai-chat-dialog
    transition: none
  #ai-chat-mask
    transition: none

// fallback launcher button (when Butterfly rightside is unavailable)
.ai-chat-float-btn
  position: fixed
  right: 16px
  bottom: calc(16px + env(safe-area-inset-bottom))
  z-index: 1002
  width: 44px
  height: 44px
  display: inline-flex
  align-items: center
  justify-content: center
  border: none
  background: var(--theme-color)
  color: #fff
  border-radius: 999px
  box-shadow: 0 8px 22px rgba(0, 0, 0, .18)
  opacity: .95
  cursor: pointer
  -webkit-tap-highlight-color: transparent

  &:active
    transform: translateY(1px)

  &:focus-visible
    outline: 3px solid rgba($theme-color, .35)
    outline-offset: 3px

