// AI Chat 组件 - 全端兼容版本

// 品牌色变量
--brand-1: #fc4a47
--brand-2: #fc636b
--brand-3: #fec9c8

// 遮罩层
#ai-chat-mask
  position: fixed
  top: 0
  left: 0
  right: 0
  bottom: 0
  z-index: 1000
  display: none
  background: rgba(0, 0, 0, .4)

  [data-theme='dark'] &
    background: rgba(0, 0, 0, .6)

// 对话框主体
#ai-chat-dialog
  position: fixed
  right: 20px
  bottom: 90px
  z-index: 1001
  display: none
  flex-direction: column
  width: 400px
  max-width: calc(100vw - 40px)
  height: 560px
  max-height: calc(100vh - 120px)
  // 背景由 JS 动态设置（随机从 /img/chat_bc/ 目录选择）
  background-color: rgba(255, 255, 255, .85)
  background-repeat: no-repeat
  background-size: cover
  background-position: center
  border-radius: 16px
  box-shadow: 0 4px 24px rgba(0, 0, 0, .15)
  overflow: hidden
  // 玻璃态效果
  backdrop-filter: blur(20px)
  -webkit-backdrop-filter: blur(20px)

  +maxWidth768()
    // 移动端全屏布局
    position: fixed
    top: 0
    left: 0
    right: 0
    bottom: 0
    width: 100%
    height: 100%
    max-width: none
    max-height: none
    border-radius: 0
    box-shadow: none
    backdrop-filter: none

// 顶部横幅
.ai-chat-banner
  display: none

  +maxWidth768()
    display: flex
    align-items: center
    justify-content: center
    position: relative
    height: 56px
    background: #fff
    padding-top: env(safe-area-inset-top, 0px)
    padding-left: 16px
    padding-right: 16px
    box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
    z-index: 10

    // 移动端深色模式也保持一致
    [data-theme='dark'] &
      background: #fff

.ai-chat-title
  font-size: 1.2em
  font-weight: 600
  color: #1f2937
  letter-spacing: 2px

  [data-theme='dark'] &
    color: #1f2937

// 关闭按钮（在横幅右侧）
.ai-chat-close-button
  display: none

  +maxWidth768()
    display: flex
    position: absolute
    right: 16px
    top: 50%
    transform: translateY(-50%)
    align-items: center
    justify-content: center
    width: 32px
    height: 32px
    border: none
    border-radius: 50%
    background: rgba(0, 0, 0, .08)
    color: #666
    cursor: pointer
    transition: background .2s

    &:hover
      background: rgba(0, 0, 0, .15)

    [data-theme='dark'] &
      background: rgba(0, 0, 0, .08)
      color: #666

      &:hover
        background: rgba(0, 0, 0, .15)

    i
      font-size: 14px

// 消息区域
.ai-chat-body
  display: flex
  flex-direction: column
  flex: 1
  min-height: 0
  padding: 12px

  +maxWidth768()
    padding: 0
    padding-left: env(safe-area-inset-left, 16px)
    padding-right: env(safe-area-inset-right, 16px)

.ai-chat-messages
  flex: 1
  min-height: 0
  overflow-y: auto
  overflow-x: hidden
  padding: 12px
  // 使用透明背景，显示父容器的背景图
  background: transparent
  border-radius: 12px

  [data-theme='dark'] &
    background: transparent

  +maxWidth768()
    // 移动端透明背景，显示父容器的背景图
    background: transparent
    border-radius: 0
    padding: 16px
    padding-bottom: 0

// 底部输入区域
.ai-chat-input-wrap
  display: flex
  align-items: center
  gap: 10px
  padding: 12px 16px
  // 玻璃态透明质感
  background: rgba(255, 255, 255, .6)
  backdrop-filter: blur(10px)
  -webkit-backdrop-filter: blur(10px)
  box-shadow: 0 -1px 3px rgba(0, 0, 0, .05)

  [data-theme='dark'] &
    background: rgba(45, 45, 48, .6)
    box-shadow: 0 -1px 3px rgba(0, 0, 0, .2)

  +maxWidth768()
    // 移动端使用 fixed 定位，跟随键盘移动
    display: flex
    position: fixed
    left: 0
    right: 0
    bottom: 0
    padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px))
    transition: bottom 0s

    // 移动端深色模式保持一致
    [data-theme='dark'] &
      background: rgba(45, 45, 48, .6)
      box-shadow: 0 -1px 3px rgba(0, 0, 0, .2)

.ai-chat-input
  flex: 1
  height: 40px
  padding: 0 14px
  border: none
  border-radius: 20px
  background: rgba(243, 244, 246, .8)
  backdrop-filter: blur(10px)
  color: #1f2937
  font-size: 16px
  outline: none

  [data-theme='dark'] &
    background: rgba(61, 61, 61, .8)
    color: #e5e5e5

  &::placeholder
    color: #9ca3af

  +maxWidth768()
    // iOS 输入框字体至少 16px 防止自动缩放
    font-size: 16px

.ai-chat-send-btn
  display: flex
  align-items: center
  justify-content: center
  width: 40px
  height: 40px
  border: none
  border-radius: 50%
  // 主题色按钮
  background: rgba(252, 74, 71, .9)
  color: #fff
  cursor: pointer
  transition: transform .1s, opacity .2s, background .2s

  &:active
    transform: scale(.95)

  &:disabled
    opacity: .5
    cursor: not-allowed

  [data-theme='dark'] &
    background: rgba(252, 74, 71, .9)
    color: #fff

  +maxWidth768()
    [data-theme='dark'] &
      background: rgba(252, 74, 71, .9)
      color: #fff

  i
    font-size: 16px

// 消息气泡
.ai-chat-msg
  margin: 10px 0

.ai-chat-bubble
  max-width: 85%
  min-height: 20px
  padding: 10px 14px
  line-height: 1.5
  white-space: pre-wrap
  word-break: break-word
  border-radius: 16px
  // 玻璃态透明质感
  background: rgba(255, 255, 255, .7)
  backdrop-filter: blur(10px)
  -webkit-backdrop-filter: blur(10px)
  color: #1f2937
  border-bottom-left-radius: 4px
  box-shadow: 0 2px 8px rgba(0, 0, 0, .08)
  // 初始隐藏，流式输出时显示
  opacity: 0
  transition: opacity .2s

  &.visible
    opacity: 1

  [data-theme='dark'] &
    background: rgba(45, 45, 48, .7)
    backdrop-filter: blur(10px)
    color: #e5e5e5
    box-shadow: 0 2px 8px rgba(0, 0, 0, .3)

.ai-chat-msg--user
  .ai-chat-bubble
    margin-left: auto
    // 透明磨砂质感，与机器人消息风格统一
    background: rgba(255, 255, 255, .7)
    backdrop-filter: blur(10px)
    -webkit-backdrop-filter: blur(10px)
    color: #1f2937
    border-bottom-right-radius: 4px
    box-shadow: 0 2px 8px rgba(0, 0, 0, .08)
    opacity: 1

  [data-theme='dark'] &
    .ai-chat-bubble
      background: rgba(45, 45, 48, .7)
      backdrop-filter: blur(10px)
      color: #e5e5e5
      box-shadow: 0 2px 8px rgba(0, 0, 0, .3)

// 引用来源（无气泡背景）
.ai-chat-citations
  margin-top: 10px
  padding: 10px 12px
  border: 1px dashed var(--brand-3, #fec9c8)
  border-radius: 10px
  font-size: .9em
  // 移除淡白色气泡背景，使用透明背景

  [data-theme='dark'] &
    border-color: rgba(255, 255, 255, .2)

  summary
    cursor: pointer
    font-weight: 500
    user-select: none
    color: var(--brand-1, #fc4a47)

    [data-theme='dark'] &
      color: #fc4a47

  &__list
    margin: 8px 0 0
    padding-left: 20px

  &__item
    margin: 6px 0

  &__link
    color: var(--brand-2, #fc636b)
    text-decoration: none
    word-break: break-word

    &:hover
      text-decoration: underline

    [data-theme='dark'] &
      color: #fc636b

// 浮动按钮（备用方案）
.ai-chat-float-btn
  position: fixed
  right: 16px
  bottom: calc(16px + env(safe-area-inset-bottom, 0px))
  z-index: 1002
  display: flex
  align-items: center
  justify-content: center
  width: 48px
  height: 48px
  border: none
  border-radius: 50%
  background: var(--brand-1, #fc4a47)
  color: #fff
  cursor: pointer
  box-shadow: 0 4px 12px rgba(252, 74, 71, .4)
  -webkit-tap-highlight-color: transparent
  transition: transform .2s, box-shadow .2s

  &:active
    transform: scale(.95)
    box-shadow: 0 2px 8px rgba(252, 74, 71, .4)

@media (prefers-reduced-motion: reduce)
  #ai-chat-dialog
    transition: none
  #ai-chat-mask
    transition: none
