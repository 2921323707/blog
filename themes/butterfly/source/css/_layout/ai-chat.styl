// AI Chat 组件 - 透明磨砂质感版本

// 弹窗打开时锁定背景滚动（解决移动端滑动时背景在动的问题）
// 同时锁 html 和 body，避免 iOS 等设备上仍滚动主文档
html.ai-chat-open
  overflow: hidden
  overscroll-behavior: none
  +maxWidth768()
    position: fixed
    left: 0
    right: 0
    width: 100%
    height: 100%

body.ai-chat-open
  overflow: hidden
  overscroll-behavior: none
  +maxWidth768()
    position: fixed
    left: 0
    right: 0
    width: 100%
    top: 0
    bottom: 0

// 遮罩层
#ai-chat-mask
  position: fixed
  top: 0
  left: 0
  right: 0
  bottom: 0
  z-index: 1000
  display: none
  background: rgba(0, 0, 0, .3)

  [data-theme='dark'] &
    background: rgba(0, 0, 0, .5)

  +maxWidth768()
    // 阻止触摸事件传递到底层，避免滑动时背景滚动
    touch-action: none

// 对话框主体
#ai-chat-dialog
  position: fixed
  right: 20px
  bottom: 20px
  z-index: 1001
  display: none
  flex-direction: column
  width: 380px
  max-width: calc(100vw - 40px)
  height: 520px
  max-height: calc(100vh - 100px)
  background: rgba(255, 255, 255, .85)
  backdrop-filter: blur(20px)
  -webkit-backdrop-filter: blur(20px)
  border-radius: 16px
  box-shadow: 0 8px 32px rgba(0, 0, 0, .12)
  overflow: hidden

  [data-theme='dark'] &
    background: rgba(30, 30, 30, .85)
    box-shadow: 0 8px 32px rgba(0, 0, 0, .4)

  +maxWidth768()
    // 移动端全屏布局
    position: fixed
    top: 0
    left: 0
    right: 0
    bottom: 0
    width: 100%
    height: 100%
    max-width: none
    max-height: none
    border-radius: 0
    box-shadow: none
    // 保留磨砂效果以保持一致性
    backdrop-filter: blur(20px)
    -webkit-backdrop-filter: blur(20px)
    background: rgba(255, 255, 255, .95)
    // 仅消息区允许纵向滑动，其余区域不把触摸传给底层，避免主页滚动
    touch-action: none

    [data-theme='dark'] &
      background: rgba(30, 30, 30, .95)

// 顶部区域（标题栏）
.ai-chat-header
  display: flex
  align-items: center
  justify-content: space-between
  padding: 14px 16px
  background: rgba(255, 255, 255, .5)
  backdrop-filter: blur(10px)
  -webkit-backdrop-filter: blur(10px)
  border-bottom: 1px solid rgba(0, 0, 0, .05)

  [data-theme='dark'] &
    background: rgba(45, 45, 48, .5)
    border-bottom-color: rgba(255, 255, 255, .05)

.ai-chat-title-wrap
  display: flex
  align-items: center
  gap: 8px

  // 移除机器人图标

.ai-chat-title
  font-size: 1em
  font-weight: 600
  color: #1f2937
  letter-spacing: 1px

  [data-theme='dark'] &
    color: #e5e5e5

.ai-chat-close
  display: flex
  align-items: center
  justify-content: center
  width: 28px
  height: 28px
  border: none
  border-radius: 8px
  background: rgba(0, 0, 0, .05)
  color: #6b7280
  cursor: pointer
  transition: background .2s, color .2s

  &:hover
    background: rgba(0, 0, 0, .1)
    color: #1f2937

  [data-theme='dark'] &
    background: rgba(255, 255, 255, .1)
    color: #9ca3af

    &:hover
      background: rgba(255, 255, 255, .15)
      color: #e5e5e5

  i
    font-size: 14px

// 消息区域
.ai-chat-body
  display: flex
  flex-direction: column
  flex: 1
  min-height: 0
  padding: 12px
  overflow: hidden

  +maxWidth768()
    padding: 12px
    padding-bottom: 0
    // 移动端为固定底部输入框留出空间
    margin-bottom: calc(60px + env(safe-area-inset-bottom, 0px))

.ai-chat-messages
  flex: 1
  min-height: 0
  overflow-y: auto
  overflow-x: hidden
  padding: 8px
  background: transparent
  border-radius: 12px
  // 平滑滚动
  -webkit-overflow-scrolling: touch

  +maxWidth768()
    padding: 8px 4px
    border-radius: 0
    // 仅此区域允许纵向滑动，触摸不会穿透到底层页面
    touch-action: pan-y

// 底部输入区域
.ai-chat-input-wrap
  display: flex
  align-items: center
  gap: 10px
  padding: 12px 14px
  background: rgba(255, 255, 255, .5)
  backdrop-filter: blur(10px)
  -webkit-backdrop-filter: blur(10px)
  border-top: 1px solid rgba(0, 0, 0, .05)

  [data-theme='dark'] &
    background: rgba(45, 45, 48, .5)
    border-top-color: rgba(255, 255, 255, .05)

  +maxWidth768()
    position: fixed
    left: 0
    right: 0
    bottom: 0
    z-index: 1002
    padding: 10px 12px
    padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px))
    background: rgba(255, 255, 255, .9)
    backdrop-filter: blur(20px)
    -webkit-backdrop-filter: blur(20px)
    border-top: 1px solid rgba(0, 0, 0, .1)

    [data-theme='dark'] &
      background: rgba(30, 30, 30, .9)
      border-top-color: rgba(255, 255, 255, .1)

.ai-chat-input
  flex: 1
  height: 36px
  padding: 0 14px
  border: none
  border-radius: 18px
  background: rgba(243, 244, 246, .9)
  color: #1f2937
  font-size: 14px
  outline: none
  transition: background .2s

  &:focus
    background: rgba(243, 244, 246, 1)

  [data-theme='dark'] &
    background: rgba(61, 61, 61, .9)
    color: #e5e5e5

    &:focus
      background: rgba(61, 61, 61, 1)

  &::placeholder
    color: #9ca3af

  +maxWidth768()
    font-size: 16px

.ai-chat-send-btn
  display: flex
  align-items: center
  justify-content: center
  flex-shrink: 0
  width: 36px
  min-width: 36px
  height: 36px
  min-height: 36px
  border: none
  border-radius: 50%
  // 柔和的灰色按钮；固定宽高保证正圆，避免移动端被压成椭圆
  background: rgba(107, 114, 128, .9)
  color: #fff
  cursor: pointer
  transition: transform .1s, opacity .2s, background .2s
  box-sizing: border-box

  &:active
    transform: scale(.95)

  &:disabled
    opacity: .4
    cursor: not-allowed

  [data-theme='dark'] &
    background: rgba(156, 163, 175, .9)

  i
    font-size: 14px

    [data-theme='dark'] &
      color: #fff

// 消息气泡
.ai-chat-msg
  margin: 8px 0

.ai-chat-bubble
  max-width: 85%
  min-height: 18px
  padding: 10px 14px
  line-height: 1.5
  white-space: pre-wrap
  word-break: break-word
  border-radius: 16px
  // 玻璃态透明质感
  background: rgba(255, 255, 255, .75)
  backdrop-filter: blur(8px)
  -webkit-backdrop-filter: blur(8px)
  color: #1f2937
  border-bottom-left-radius: 4px
  box-shadow: 0 2px 6px rgba(0, 0, 0, .06)
  // 初始隐藏，流式输出时显示
  opacity: 0
  transition: opacity .2s

  &.visible
    opacity: 1

  [data-theme='dark'] &
    background: rgba(45, 45, 48, .75)
    backdrop-filter: blur(8px)
    color: #e5e5e5
    box-shadow: 0 2px 6px rgba(0, 0, 0, .2)

.ai-chat-msg--user
  .ai-chat-bubble
    margin-left: auto
    // 统一使用透明磨砂质感
    background: rgba(255, 255, 255, .75)
    backdrop-filter: blur(8px)
    -webkit-backdrop-filter: blur(8px)
    color: #1f2937
    border-bottom-right-radius: 4px
    border-bottom-left-radius: 16px
    box-shadow: 0 2px 6px rgba(0, 0, 0, .06)
    opacity: 1

  [data-theme='dark'] &
    .ai-chat-bubble
      background: rgba(45, 45, 48, .75)
      backdrop-filter: blur(8px)
      color: #e5e5e5
      box-shadow: 0 2px 6px rgba(0, 0, 0, .2)

// 引用来源
.ai-chat-citations
  margin-top: 8px
  padding: 10px 12px
  border: 1px dashed rgba(107, 114, 128, .3)
  border-radius: 10px
  font-size: .85em

  [data-theme='dark'] &
    border-color: rgba(156, 163, 175, .4)

  summary
    cursor: pointer
    font-weight: 500
    user-select: none
    color: #4b5563
    font-size: .9em

    [data-theme='dark'] &
      color: #d1d5db

  &__list
    margin: 8px 0 0
    padding-left: 18px

  &__item
    margin: 5px 0

  &__link
    color: #4b5563
    text-decoration: none
    word-break: break-word
    font-size: .9em

    &:hover
      text-decoration: underline

    [data-theme='dark'] &
      color: #d1d5db

// 浮动按钮
.ai-chat-float-btn
  position: fixed
  right: 16px
  bottom: calc(16px + env(safe-area-inset-bottom, 0px))
  z-index: 1002
  display: flex
  align-items: center
  justify-content: center
  width: 44px
  height: 44px
  border: none
  border-radius: 50%
  // 柔和的灰色按钮
  background: rgba(107, 114, 128, .9)
  color: #fff
  cursor: pointer
  box-shadow: 0 4px 12px rgba(0, 0, 0, .15)
  -webkit-tap-highlight-color: transparent
  transition: transform .2s, box-shadow .2s

  &:active
    transform: scale(.95)
    box-shadow: 0 2px 8px rgba(0, 0, 0, .2)

  i
    font-size: 18px

    [data-theme='dark'] &
      color: #fff

@media (prefers-reduced-motion: reduce)
  #ai-chat-dialog
    transition: none
  #ai-chat-mask
    transition: none

// AI 板块页面：入口卡片（支持拓展列表）
.ai-page-assistant
  margin-bottom: 2rem
  display: flex
  flex-direction: column
  gap: 1.25rem

.ai-page-assistant__card
  padding: 1.5rem 1.75rem
  border-radius: 12px
  background: rgba(255, 255, 255, 0.6)
  backdrop-filter: blur(12px)
  -webkit-backdrop-filter: blur(12px)
  border: 1px solid rgba(0, 0, 0, 0.06)
  [data-theme='dark'] &
    background: rgba(30, 30, 30, 0.6)
    border-color: rgba(255, 255, 255, 0.08)

.ai-page-assistant__head
  display: flex
  align-items: center
  gap: 0.6rem
  margin-bottom: 0.75rem

.ai-page-assistant__icon
  color: var(--theme-color, #49b1f5)
  font-size: 1.5rem

.ai-page-assistant__title
  margin: 0
  font-size: 1.25rem
  font-weight: 600

.ai-page-assistant__desc
  margin: 0 0 1.25rem
  color: var(--font-color)
  font-size: 0.95rem
  line-height: 1.6
  opacity: 0.9

.ai-page-assistant__btn
  display: inline-flex
  align-items: center
  gap: 0.5rem
  padding: 0.6rem 1.25rem
  border: none
  border-radius: 8px
  background: var(--theme-color, #49b1f5)
  color: #fff
  font-size: 0.95rem
  cursor: pointer
  transition: opacity 0.2s, transform 0.15s
  text-decoration: none
  &:hover
    opacity: 0.9
    transform: translateY(-1px)
  &:active
    transform: translateY(0)
  &--primary
    cursor: pointer
  &--disabled
    cursor: default
    background: rgba(0, 0, 0, 0.12)
    color: var(--font-color)
    opacity: 0.85
    [data-theme='dark'] &
      background: rgba(255, 255, 255, 0.12)
    &:hover
      transform: none
      opacity: 0.85

.ai-page-content
  margin-top: 1.5rem
